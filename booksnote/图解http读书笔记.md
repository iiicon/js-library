## 了解 web 及网络基础

### 使用 http 访问 web

1. http：HyperText Transfer Protocal 超文本传输协议，可以说 web 是建立在 http 协议上通信的
2. 网络基础 TCP/IP 协议族， http 是他的一个子集
3. TCP/IP 的分层管理，分为四层：应用层，传输层，网络层，数据链路层。
    1. 应用层决定了向用户提供应用服务是通信的活动 http DNS
    2. 传输层对上层应用层，提供处于网络连接中两台计算机的数据传输 TCP UDP
    3. 网络层用来处理在网络上流动的数据包，该层决定了通过怎样的路径到达对方计算机
    4. 链路层用来处理连接网络的硬件部分，包括控制操作系统、硬件的设备驱动、NIC（网卡），以及光纤等物理可见部分
4. TCP/IP 通信数据流
    ![示意图](http://p1ix9dj97.bkt.clouddn.com/940171-20170308000555563-666203198.png)
    这种把数据信息包装起来的做法称为封装（encapsulate）
5. 与 Http 密切相关的 3 个协议（IP, TCP, DNS）
    1. IP 协议位于网络层，他的作用就是把各种数据包传输给对方，要保证确实传送到需要两个条件， IP 地址和 MAC 地址，IP 地址是指节点被分配的地址， MAC 地址是网卡所属的固定地址，这两可以进行配对，ip 可变， mac 地址基本不变
    2. 使用 ARP (address resolution Protocal) 协议凭借 mac 地址进行通信，作为中转，他是一中解析地址的协议，根据 IP 可反查出 mac 地址
    3. TCP 位于传输层，提供可靠的字节流服务（byte stream service）为了传输将大块数据分割成报文段为单位的数据包进行管理，一言以蔽之，TCP 协议为了更容易传输大数据才把数据分割，而且 TCP 协议能够准确确认最终是否送达对方
        - 当然这个时候就需要三次握手了 ![示意图](http://p1ix9dj97.bkt.clouddn.com/825196-20170327122810983-651007038.jpg)
        - 上图所示，tcp 采用 flag -- SYN(synchronize) 和 ACK (acknowledgement) 确认收到的信，简单说一下流程，发送端首先发送一个带 syn 标志的数据包给对方，服务端接受到后，回传一个带有 syn/ack 标志的数据包以示传达确认信息，最后，发送端再回传一个带 ACK 标志的数据包，代表‘握手结束’
    4. 负责域名解析的 DNS 服务，（Domain Name System）处于应用层，他提供域名到 ip 地址之间的解析服务
    5. 与 URI（Uniform Resource Identifier） 相比，我们更熟悉 URL（Uniform Resource Locator），URI 用字符串标识某一互联网资源，而 URL 表示资源的地点，所以 url 是 uri 子集
        - uri 包括登录信息，服务器地址，服务器端口号，带层次的文件路径，查询字符串，片段表示符
        ```
            http://user:pass@www.example.jp:80/dir/index.html?uid=1#hash1
        ```

### 简单的 HTTP 协议


#### http 协议用于客户端和服务端之间的通信

  用 http 协议就可以区分哪端是客户端，哪端是服务端

#### 通过请求和响应的交换达成通信

#### http 是不保存状态的协议（stateless protocal）
    
  也就是说协议对于发送过的请求或响应都不做持久化处理，不保留之前一切的请求或响应报文的信息。这是为了更快的处理大量事物，确保协议的可伸缩性
    
#### 请求 URI 定位资源
  http 协议使用 URI 定位互联网上的资源，除此之外，如果不是访问特定的资源而是对服务器本身发起请求就可以用一个 * 来代替请求 URI
    
#### 告知服务器意图的 http 方法

  1. GET： 获取资源
  2. POST： 传输实体主体 （主要目的不是获取相应的主体内容） 
  3. PUT： 传输文件 （本身不带验证机制）
  4. TRACE： 容易引发 XST， 一般也不怎么用
  5. CONNECT： 要求用隧道协议连接代理 （主要使用 SSL TLS）把通信内容加密后经网络隧道传输

#### 使用方法下达命令

  GET POST PUT HEAD DELETE OPTIONS TRACE CONNECT
  
#### 持久连接节省通信量

  1. HTTP keep-alive 持久连接的好处在于减少了 tcp 连接的重复建立和断开所造成的额外开销，减轻了服务端的负载，这样 web 页面你的显示速度也就相应的提高了。http/1.1 所有的连接默认都是持久连接
  2. 管线化（pipelining）不用等待相应亦可直接发送下一个请求

#### 使用 cookie 的状态管理

  不可否认，无状态的协议当然有它的优点。由于不必保存状态，自然可以减少服务器的 cpu 及内存资源的消耗。因为简单，所以被应用在各种场景里。
  cookie 技术在请求和相应的报文中写入 cookie 信息来控制客户端的状态。cookie 会根据从服务端发送的响应报文内的一个叫做 set-cookie 的首部字段信息，通知客户端保存 cookie ，下次客户端再往服务器发送请求时，客户端会在请求报文中加入 cookie 值后发送出去。
  ```
  Set-Cookie: sid=132525583905; path=/; expires=wed,10-oct-12 ...
  
  Cookie: sid=132525583905
  ```
  
### 3.HTTP 报文内的 http 信息

#### HTTP 报文

用于 HTTP 协议交互的信息被称为 http 报文，请求端的称为请求报文，相应端的称为相应报文。http 报文本身是由多行数据构成的字符串文本。

http 报文大致分为报文首部和报文主体两块。两者由最初的（CR+LF）来划分，通常，并不一定要有报文主体。

#### 请求报文及响应报文的结构

        
```
graph LR
请求报文--> 请求报文首部
请求报文--> 空行
请求报文--> 报文主体
请求报文首部-->请求行
请求报文首部-->请求首部字段
请求报文首部-->通用首部字段
请求报文首部-->实体首部字段
请求报文首部-->其他
报文主体-->实体主体
```
```
graph LR
响应报文--> 响应报文首部
响应报文--> 空行
响应报文--> 报文主体
响应报文首部-->状态行
响应报文首部-->响应首部字段
响应报文首部-->通用首部字段
响应报文首部-->实体首部字段
响应报文首部-->其他
报文主体-->实体主体
```
- 可以看出来，首部字段一般有四种，分别是通用首部，请求首部，响应首部，实体首部
- 而报文的首部则是由请求行，状态行，首部字段，其他组成

#### 编码提升传输速率

##### 报文主体和实体主体的差异

- 报文（message）是 http 通信中的基本单位，由八位组字节流组成（octet sequence），通过 http 通信传输
- 实体（entity）作为请求或响应的有效载荷数据被传输，其内容由实体首部和实体主体组成
  http 报文的主体用于传输请求或响应的实体主体，通常报文主体等于实体主体，只有当传输中进行编码操作时，实体主体的内容发生变化，才导致它和报文主体产生差异

##### 压缩传输的内容编码
- 内容编码指明应用在实体内容上的编码格式，并保持实体信息原样压缩，内容编码后的实体由客户端接受并负责解码
- 常用的编码有一下几种  

  1.gzip  (GNU zip)    
  2.compress (UNIX 系统的标准压缩)   
  3.deflate (zlib)   
  4.identity (不进行压缩)

##### 分割发送的分块传输编码
- 把实体主体分块的功能称为分块传输编码 chunked transfer coding

##### 发送多种数据的多部分对象集合
- MIME multipurpose Internet Mail Extensions （多用途因特网邮件扩展机制）
- MIME 扩展中会使用一种称为多部分对象集合（multipart）的方法，来容纳多份不同类型的数据，http 协议中也采用了这种方法。
- 多部分对象集合包含的对象如下
  
  1. multipart/form-data 在 web 表单文件上传时使用
  2. multipart/byteranges 在状态码 206 响应报文包含了多个范围的内容时使用

 
#### 获取部分内容的范围请求

- 指定范围发送的请求叫做范围请求（Range Request）
- 执行请求时，会用到首部字段 Range 来指定资源的 byte 范围
``` 
Range: bytes = 5001-10000
Range: bytes = 5001-
Range: bytes = -3000, 5000-7000
```
- 响应会返回 206 partial content，而且会在首部字段 content-type 标明 multipart/bytesranges 后返回响应报文，如果服务器无法响应范围请求，就会返回 200 和完整的尸体内容

#### 内容协商返回最合适的内容
- 内容协商机制 content negotiation，是指客户端和服务端就响应的资源内容进行交涉，然后提供给客户端最为适合的资源，内容协商会以响应资源的语言，字符集，编码方式等最为判断的基准，包含在请求报文中的某些字段就是判断的基准：

  1. Accept
  2. Accept-Charset
  3. Accept-Encoding
  4. Accept-Language
  5. Content-Language


### HTTP 状态码

#### 状态码告知服务器请求返回的结果
状态码的类别

xxx | 类别 | 原因短语
---|---|--
1xx | informational（信息性状态码） | 接受的请求正在处理
2xx | success （成功状态码）| 请求正常处理完毕
3xx | Redirection（重定向状态码）| 需要进行附加操作以完成请求
4xx | Client Error（客户端错误状态码）| 服务器无法处理请求
5xx | Server Error（服务器错误状态码）| 服务器请求出错

具有代表性的 14 种状态码

1. 200 OK 表示从客户端发来的请求在服务端被正常处理了
2. 204 No Content 表示服务器接受的请求已成功处理，但在返回的响应报文中不含实体的主体部分，比如返回 204 之后，浏览器显示的页面不更新
3. 206 Partial Content 表示客户端进行了范围请求，而服务器成功执行了这部分的 GET 请求
4. 301 Move Permanently 表示永久性重定向，当指定资源的路径最后忘记添加横杠，就会产生 301 状态码，如 `http://example.com/sample`
5. 302 Found 临时性重定向 
6. 303 See Other 表示由于请求对应的资源存在着另一个 URI，应使用 GET 方法定向获取请求的资源
7. 304 Not Modified 表示客户端发送附带条件的请求时，服务端允许请求访问资源，但因发生未满足条件的请求后，直接返回 304
8. 307 Temporary Redirect 基本和 302 相同，不会阻止转换方法
9. 400 Bad Request 表示请求报文中存在语法错误
10. 401 Unauthorized 表示发送的请求需要通过 HTTP 认证的认证信息，若之前已经进行过 1 次请求，则表示用户认证失败、
11. 403 Forbidden 请求资源的访问别服务器拒绝了
12. 404 Not Found 表示服务器上无法找到请求的资源
13. 500 Internal Server Error 标明服务器端在执行请求时发生了错误，也有可能是 web 应用的 bug 或某些临时的故障
14. 503 Service Unavailable 表示服务端暂时处于超负荷或正在进行停机维护
15. 504 Gateway Timeout                                                                                                                                                           

### 与 HTTP 协作的 web 服务器

#### 用单台虚拟主机实现多个域名
在相同的 IP 地址下，由于虚拟主机可以寄存多个不同的主机名和域名的 web 网站，新词在发送请求的时候，必须在 Host 首部内完整指定主机名和域名

#### 通信数据转发程序：代理、网关、隧道

> 代理是一种有转发功能的应用程序，他扮演了位于服务器和客户端中间人的角色，接受客户端发送的请求并转发给服务器，同时也接受服务器返回的响应并转发给客户端
  
  转发请求需要附加 via 首部字段以标识出经过的主机信息
  使用缓存代理服务器的理由有： 利用缓存技术减少网络带宽的流量，组织内部针对特定网站的访问控制，以获取访问日志为主要目的
  代理有两种分类，一种是是否使用缓存，另外一种是是否修改报文。比如缓存代理和透明代理
  
  
> 网关是转发其他服务器通信数据的服务器，接受到从客户端发送来的请求时，它就像自己拥有服务器一样对资源进行处理，又是客户端都不会察觉，自己的通信目标是一个网关

  网关的工作机制和代理十分相似，而网关能使通信线路上的服务提供非 HTTP 协议服务


> 隧道是在相隔甚远的客户端和服务端两者之间进行中转，并保持双方通信连接的应用程序

  隧道可按要求建立起一条与其他服务器的通信线路，届时使用 ssl 等加密手段进行通信，隧道的目的是确保客户端和服务端能进行安全通信
  
#### 保存资源的缓存

> 缓存是指代理服务器或客户端本地磁盘内保存的资源副本，当然缓存服务器是代理服务器的一种，归类在缓存代理类型中

  缓存是有有效期的

### HTTP 首部

HTTP 首部字段一览

* 通用首部字段

首部字段名 | 说明
---|---
Cache-Control | 控制缓存的行为
Connection | 逐跳首部、连接的管理
Date | 创建报文的日期时间
Pragma | 报文指令
Trailer | 报文末端的首部一览
Transfer-Encoding | 指定报文主体的传输编码方式
Upgrade | 升级为其他协议
Via | 代理服务器的相关信息
Warning | 错误通知

* 请求首部字段

首部字段名 | 说明
---|---
Accept | 用户代理可处理的媒体类型
Accept-Charset | 优先的字符集
Accept-Encoding | 优先的内容编码
Accept-Language | 优先的语言
Authorization | WEB 认证信息
Expect | 期待服务器的特定行为
From | 用户的电子邮箱地址
Host | 请求资源所在的服务器
If-Match | 比较实体标记（ETag）
If-Modify-Since | 比较资源的更新时间
If-None-Match | 比较实体标记，与 If-Match 相反
If-Range | 资源未更新时发送实体 Byte 的范围请求
If-Unmodified-Since | 比较资源的更新时间，与 if-modify-since 相反
Max-forwards | 最大传输逐跳数
Proxy-Authorization | 代理服务器要求客户端的认证信息
Range | 实体的字节范围请求
Referer | 对请求中 URI 的原始获取方
TE | 传输编码的优先级
User-Agent | HTTP 客户端程序的信息

* 响应首部字段

首部字段名 | 说明
---|---
Accept—Ranges | 是否接受字节范围请求
Age | 推算资源创建经过的时间
Etag | 资源的匹配信息
Location | 令客户端重定向至指定的 URI
Proxy-Authenticate | 代理服务器对客户端的认证信息
Retry-After | 对再次发送请求的时机要求
Server | HTTP 服务器的安装信息
Vary | 代理服务器缓存的管理信息
WWW-authenticate | 服务器对客户端的认证信息

* 实体首部字段

首部字段名 | 说明
---|---
Allow | 资源可支持的 HTTP 方法
Content-Encoding | 实体主体适用的编码方式
Content-Language | 实体主体的自然语言
Content-Length | 实体主体的大小
Content-Location | 替代对应资源的 URI
Content-MD5 | 实体主体的报文摘要
Content-Range | 实体主体的位置范围
Content-Type | 实体主体的媒体类型
Expires | 实体主体过期的日期时间
Last-Modified | 资源的最后修改日期时间


### hTTPS

HTTP 的缺点
1. 通信中使用明文，内容可能被窃听
2. 不验证通信方的身份，因此有可能遭遇伪装
3. 无法证明报文的完整性，所以有可能已经遭到篡改


##### 通信使用明文可能会被窃听

1. 通信的加密
2. 内容的加密

##### 不验证通信方的身份就可能遭遇伪装
##### 无法证明报文的完整性，可能已遭篡改

HTTP + 加密 + 认证 + 完整性保护 = HTTPS

1. http 加上加密处理和认证以及完整性保护后就是 https
2. https 是身披 ssl 外壳的 http
3. 相互交换缪安平的公开密钥加密技术
4. 证明公开密钥正确性的证书
5. HTTPS 的安全通行机制


### 确认访问用户身份的认证
1. 认证
2. BASIC 认证
3. DIGEST 认证
4. SSL 客户端认证
5. 基于表单认证
  认证多半为基于表单认证 
  Session 管理及 Cookie 应用

### 基于 HTTP 的功能追加协议
1. SPDY
2. WebSocket
  1. 推送功能
  2. 减少通信量
3. HTTP2.0
4. WebDAV

### 构建 WEB 内容的技术
1. HTML
2. 动态 HTML
3. Web 应用
4. 数据发布的格式及语言

### web 的攻击技术

#### 针对 Web 的攻击技术
1. HTTP 不具备必要的安全功能
2. 在客户端即可篡改请求
3. 针对 web 应用的攻击模式
  1. 以服务器为主的主动攻击
  2. 以服务器为主的被动攻击

#### 因输出值转义不完全引发的安全漏洞

##### 跨站脚本攻击
是指通过存在安全漏洞的 web 网站注册用户的浏览器内运行非法的 html 或者 js 进行的一种攻击

可能造成以下影响
  1. 利用虚假输入表单骗取用户个人信息
  2. 用脚本窃取用户的 Cookie 值，被害者在不知情的情况下，帮助攻击者发送恶意请求
  3. 显示伪造的文章或图片

XSS 是攻击者利用预先设置的陷阱触发的被动攻击

##### sql 注入攻击
sql injection 是指针对 web 应用使用的数据库，通过运行非法的 sql 而产生的攻击

##### OS 命令注入攻击
OS Command Injection 是指通过 web 应用，执行非法的操作系统命令达到攻击的目的，只要在能调用 shell 函数的地方就存在被攻击的风险

##### HTTP 首部注入攻击
HTTP Header Injection 是指攻击者通过在响应首部字段内插入换行，添加任意响应首部或主体的一种攻击，属于被动攻击模式

##### 邮件首部注入攻击
##### 目录遍历攻击
##### 远程文件包含漏洞

#### 因设置或者设计上的缺陷引发的安全漏洞
1. 强制浏览
2. 不正确的错误消息处理
3. 开放重定向

#### 因会话管理疏忽引发的安全漏洞
##### 会话劫持 和 会话固定劫持 都是拿到 sessionID 伪装成用户进行攻击

##### 跨站点请求伪造
Cross Site Request Forgeries CSRF 攻击是指攻击者通过设置好的陷阱，强制对已完成认证的用户进行非预期的个人信息或设定信息等某些状态更新，属于被动攻击。
可能会造成以下影响
1. 利用已通过认证的用户权限更新设定信息
2. 利用已通过认证的用户权限购买商品
3. 利用已通过认证的用户权限在留言板上发表言论


#### 其他安全漏洞
1. 密码破解
2. 点击劫持
3. Dos 攻击
4. 后门程序










